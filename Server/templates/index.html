<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  // ===== Fixed MQTT Topic =====
  const TOPIC = "cx/iotbox01/sensors";
  const TOPIC_heater = "cx/iotbox01/heater"

  const connDot = document.getElementById("connDot");
  const connText = document.getElementById("connText");

  const tempValue = document.getElementById("tempValue");
  const humValue  = document.getElementById("humValue");
  const winValue  = document.getElementById("winValue");
  const heaterAdvice = document.getElementById("heaterAdvice");

  const tempAt = document.getElementById("tempAt");
  const humAt  = document.getElementById("humAt");
  const winAt  = document.getElementById("winAt");

  const logEl = document.getElementById("log");

  const btnConnect = document.getElementById("btnConnect");
  const btnDisconnect = document.getElementById("btnDisconnect");

  const HEATER_ON = true;

  let client = null;

  // Remember last heater command to avoid spamming MQTT
  let lastHeaterCmd = null;

  function now(){ return new Date().toLocaleTimeString(); }

  function log(msg){
    logEl.textContent += `[${now()}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function setConn(ok, text){
    connDot.className = "dot " + (ok ? "ok" : "bad");
    connText.textContent = text;
  }

  function safeNumber(x){
    const n = Number(x);
    return Number.isFinite(n) ? n : null;
  }

  function publishHeater(command){
    if (!client) return;

    // Only publish if changed
    if (command === lastHeaterCmd) return;

    lastHeaterCmd = command;
    const payload = JSON.stringify({ command });

    client.publish(TOPIC_HEATER, payload);
    log(`→ publish ${TOPIC_HEATER} ${payload}`);
  }

  btnConnect.onclick = () => {
    const url = document.getElementById("wsUrl").value.trim() || "ws://10.215.255.119:9001";

    setConn(false, "Connecting...");
    log(`Connecting to ${url} ...`);

    // Good practice: set a clientId
    client = mqtt.connect(url, { clientId: "web_" + Math.random().toString(16).slice(2) });

    client.on("connect", () => {
      setConn(true, "Connected");
      btnDisconnect.disabled = false;

      client.subscribe(TOPIC, (err) => {
        if (err) log("❌ subscribe error: " + (err.message || err));
        else log("✅ subscribed to " + TOPIC);
      });
    });

    client.on("message", (topic, payload) => {
      if (topic !== TOPIC) return;

      const raw = payload.toString();
      log(`← ${topic} ${raw}`);

      try {
        const data = JSON.parse(raw);

        // Validate / parse numbers
        const t = safeNumber(data.temperature);
        const h = safeNumber(data.humidity);
        const w = safeNumber(data.window);

        // Update UI safely
        if (t !== null) tempValue.textContent = t.toFixed(1);
        else tempValue.textContent = "--";

        if (h !== null) humValue.textContent = h.toFixed(1);
        else humValue.textContent = "--";

        if (w !== null) winValue.textContent = w.toFixed(0);
        else winValue.textContent = String(data.window ?? "--");

        tempAt.textContent = humAt.textContent = winAt.textContent = now();

        // Simple decision logic (example)
        if (data.window > 500 && HEATER_ON) {
          heaterAdvice.textContent = "Turn OFF heater";
        }else{
          heaterAdvice.textContent = "Turn ON heater";
        }

        heaterAdvice.textContent = advice;
        publishHeater(cmd);

      } catch(e){
        log("❌ JSON parse error: " + e.message);
      }
    });

    client.on("reconnect", () => setConn(false, "Reconnecting..."));

    client.on("close", () => {
      setConn(false, "Disconnected");
      btnDisconnect.disabled = true;
      log("Disconnected");
      lastHeaterCmd = null;
    });

    client.on("error", (e) => {
      log("❌ mqtt error: " + (e.message || e));
    });
  };

  btnDisconnect.onclick = () => {
    if (client) {
      log("Disconnect requested");
      client.end(true);
      client = null;
    }
  };

  setConn(false, "Disconnected");
</script>
